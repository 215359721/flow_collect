<template>
  <div class="main-page">
    <div class="opt-level">
      <el-form
        :model="form"
        ref="form"
        inline
        label-width="120px"
      >
        <el-form-item
          id="keyWord"
          prop="keyWord"
        >
          <el-select
            size="mini"
            v-model="form.keyWord"
            filterable
            clearable
            remote
            reserve-keyword
            placeholder="请输入关键词"
            :remote-method="remoteMethod"
            :loading="loading"
          >
            <el-option
              v-for="item in keyWordOptions"
              :key="item.value"
              :label="item.label"
              :value="item.value"
            >
            </el-option>
          </el-select>
        </el-form-item>
        <el-form-item prop="level">
          <el-select
            size="mini"
            v-model="form.level"
            placeholder="请选择"
          >
            <el-option
              v-for="item in levelOptions"
              :key="item.value"
              :label="item.label"
              :value="item.value"
            >
            </el-option>
          </el-select>
        </el-form-item>
        <!-- <el-form-item prop="layout">
          <el-select
            size="mini"
            v-model="form.layout"
            placeholder="请选择"
          >
            <el-option
              v-for="item in layoutOptions"
              :key="item.value"
              :label="item.label"
              :value="item.value"
            >
            </el-option>
          </el-select>
        </el-form-item> -->
        <el-form-item>
          <el-button
            type="primary"
            size="mini"
            @click="handleSearch"
          >查询</el-button>
          <el-dropdown
            size="mini"
            v-if="false"
            split-button
            type="primary"
            @command="changeLayout"
            :style="{marginLeft:'10px'}"
          >
            布局切换
            <el-dropdown-menu slot="dropdown">
              <el-dropdown-item command="radiation">语义网辐射树</el-dropdown-item>
              <el-dropdown-item command="mind">语义网脑图树</el-dropdown-item>
            </el-dropdown-menu>
          </el-dropdown>
        </el-form-item>
      </el-form>
    </div>
    <div
      id="graphemeDiv"
      v-if="isShow"
    ></div>
    <div
      v-else
      class="el-empty"
    >
      <img src="../assets/image/single.png">
      <label>暂无数据</label>
    </div>
  </div>
</template>

<script>
// eslint-disable-next-line no-unused-vars
import _ from "lodash";
import G6 from "@antv/g6";
import insertCss from "insert-css";
import loading from "../utils/loading";
// eslint-disable-next-line no-unused-vars
// import graphemeTreeData from "../mock/grapheme-tree";
import { showTooltip } from "../data/tree-tooltip";
import innerCss from "../data/insertCss";
import { getTreeNode, getKeywordsList } from "../api/api.js";
import { createUuid } from "../utils/common.js";
import custNode from "../data/task_node";
import { baseUrl } from "../config";
import { debounce } from "../utils/common";

// eslint-disable-next-line no-unused-vars
import { useMockData, mys } from "../config/index";
import mock_treeData from "../mock/FinishData/treeData";
import nodeNewUI from '../data/newNode/tree_node_newUI'
insertCss(innerCss);

export default {
  components: {},
  data () {
    return {
      //window对象
      win: {
        height: 0,
        width: 0
      },
      sourceData: {}, //数据源
      graph: null, //graph全局对象
      rankDir: "LR", //当前布局方式
      canvasCenter: [0, 0], //画布中心
      toolBar: null, //工具栏
      minimap: null, //小地图
      toolTip: "", //提示框内容
      rightMenu: null, //右键菜单
      isShow: false,
      childNodes: [],
      isRender: false,
      selectNode: undefined,
      form: {
        level: 2,
        keyWord: "功率继电器",
        layout: "mind"
      },
      levelOptions: [
        {
          value: 2,
          label: "2"
        },
        {
          value: 3,
          label: "3"
        },
        {
          value: 4,
          label: "4"
        }
      ],
      layoutOptions: [
        {
          value: "radiation",
          label: "语义网辐射树"
        },
        {
          value: "mind",
          label: "语义网脑图树"
        }
      ],
      centerNode: undefined,
      keyWordOptions: [],
      list: [],
      loading: false,
      firstLoading: true
    };
  },
  computed: {},
  created () {
    this.getParams();
  },
  methods: {
    // 获取初始树节点
    async getTreeNode () {
      if (!this.selectNode) {
        console.log("获取初始树节点-搜索节点");
        const params = {
          layer: this.form.level,
          type: this.form.keyWord
        };
        let res = '', resData = ''
        if (useMockData) {
          resData = mock_treeData
        } else {
          res = await getTreeNode(params);
          resData = res.data
        }
        this.sourceData = this.initData(resData);
        this.centerNode = this.sourceData;
      } else {
        console.log("获取初始树节点-点击节点");
        const params = {
          layer: this.form.level,
          type: this.selectNode.getModel().name
        };
        const res = await getTreeNode(params);
        this.childNodes = res.data;
        if (this.childNodes && this.childNodes.children.length) {
          await this.recursionConcat(this.sourceData);
        }
      }
    },
    // 递归拼接children
    recursionConcat (data) {
      let processedData;
      if (Object.prototype.toString.call(data).slice(8, -1) === "Object") {
        processedData = [data];
      } else if (
        Object.prototype.toString.call(data).slice(8, -1) === "Array"
      ) {
        processedData = data;
      }
      processedData.map(async item => {
        if (item.id === this.selectNode.getModel().id) {
          const formateData = await this.initData(this.childNodes);
          item.children = formateData.children;
          this.isRender = true;
        } else {
          if (item.children && item.children.length) {
            this.recursionConcat(item.children);
          }
        }
      });
    },
    // 脑图树node点击事件
    async handleMindNodeClick (event) {
      loading.show();
      this.isRender = false;
      this.selectNode = event.item;
      if (
        this.selectNode.getModel().type === "custTree_node" &&
        !this.selectNode.getModel().children.length
      ) {
        await this.getTreeNode(this.selectNode);
      }
      if (this.isRender && !this.selectNode.getModel().collapsed) {
        this.graph.changeData(this.sourceData);
        this.graph.fitCenter();
        this.graph.zoom(1.2, {
          x: this.win.width / 2,
          y: this.win.height / 2
        });
      }
      console.log("聚焦节点：", this.selectNode.getModel());
      this.graph.focusItem(this.selectNode.getModel().id, true, {
        duration: 400
      });
      this.graph.getNodes().forEach(node => {
        this.graph.clearItemStates(node);
        this.graph.setItemState(node, "dark", true);
      });
      this.graph.setItemState(this.selectNode._cfg.id, "dark", false);
      this.graph.setItemState(this.selectNode._cfg.id, "highlight", true);
      loading.hide();
    },
    // 辐射树node点击事件
    async handleRadiaNodeClick (event) {
      loading.show();
      this.isRender = false;
      this.selectNode = event.item;
      if (
        this.selectNode.getModel().type === "custTree_node" &&
        !this.selectNode.getModel().children.length
      ) {
        await this.getTreeNode(this.selectNode);
      }
      if (this.isRender && !this.selectNode.getModel().collapsed) {
        this.graph.changeData(this.sourceData);
        this.graph.fitCenter();
        this.graph.zoom(1.2, {
          x: this.win.width / 2,
          y: this.win.height / 2
        });
      }
      this.graph.focusItem(this.selectNode.getModel().id);
      this.graph.getNodes().forEach(node => {
        this.graph.clearItemStates(node);
        this.graph.setItemState(node, "dark", true);
      });
      this.graph.setItemState(this.selectNode._cfg.id, "dark", false);
      this.graph.setItemState(this.selectNode._cfg.id, "highlight", true);
      loading.hide();
    },
    // 初始化辐射树G6
    async initG6 () {
      const container = document.getElementById("graphemeDiv");
      this.graph = new G6.TreeGraph({
        container: container,
        width: this.win.width,
        height: this.win.height,
        linkCenter: true,
        modes: {
          default: [
            {
              type: "collapse-expand",
              onChange: function onChange (item, collapsed) {
                const data = item.get("model");
                data.collapsed = collapsed;
                return true;
              }
              // 关系节点不发生折叠
              // shouldBegin: (e) => {
              //   // 若当前操作的节点 type 不为 'custTree_node'，则不发生 collapse-expand
              //   if (e.item && e.item.getModel().type !== "custTree_node") return false;
              //   return true;
              // },
            },
            "drag-canvas",
            "zoom-canvas"
          ]
        },
        plugins: [this.toolBar, this.toolTip, this.minimap, this.rightMenu],
        nodeStateStyles: {
          highlight: {
            stroke: "#eaff8f",
            lineWidth: 5
          },
          dark: {
            opacity: 0.5
          }
        },
        defaultNode: {
          style: {
            cursor: "pointer"
          },
          labelCfg: {
            position: "bottom",
            offset: 10,
            style: {
              // ... 文本样式的配置
            }
          }
        },
        layout: {
          type: "dendrogram",
          direction: "LR",
          nodeSep: 20,
          rankSep: 100,
          radial: true
        }
      });
      this.graph.node(node => {
        if (node.type === "node" || node.type === "custTree_node") {
          if (node.name.length > 10) {
            return {
              label: node.name.substring(0, 10) + "..."
            };
          } else {
            return {
              label: node.name
            };
          }
        } else {
          return {
            label: ""
          };
        }
      });
      this.graph.data(this.sourceData);
      this.graph.render();
      this.graph.fitCenter();
      this.graph.zoom(1.2, {
        x: this.win.width / 2,
        y: this.win.height / 2
      });
      this.graph.on("node:click", this.handleRadiaNodeClick);
      //监听：canvas点击
      this.graph.on("canvas:click", () => {
        this.clearAllStats();
      });
    },
    // 初始化脑图树G6
    initMindG6 () {
      const container = document.getElementById("graphemeDiv");
      this.graph = new G6.TreeGraph({
        container: container,
        width: this.win.width,
        height: this.win.height,
        modes: {
          default: [
            {
              type: "collapse-expand",
              onChange: function onChange (item, collapsed) {
                const data = item.get("model");
                data.collapsed = collapsed;
                return true;
              }
              // 关系节点不发生折叠
              // shouldBegin: (e) => {
              //   // 若当前操作的节点 type 不为 'custTree_node'，则不发生 collapse-expand
              //   if (e.item && e.item.getModel().type !== "custTree_node") return false;
              //   return true;
              // },
            },
            "drag-canvas",
            "zoom-canvas"
          ]
        },
        plugins: [this.toolBar, this.toolTip, this.minimap, this.rightMenu],
        nodeStateStyles: {
          highlight: {
            stroke: "#eaff8f",
            lineWidth: 5
          },
          dark: {
            opacity: 0.5
          }
        },
        defaultNode: {
          style: {
            cursor: "pointer",
            lineWidth: 3
          },
          anchorPoints: [[0, 0.5], [1, 0.5]]
        },
        defaultEdge: {
          type: "cubic-horizontal",
          color: "#cccccc",
          style: {
            lineWidth: 1
          }
        },
        layout: {
          type: "mindmap",
          direction: "H",
          getHeight: () => {
            return 50;
          },
          getWidth: () => {
            return 36;
          },
          getVGap: () => {
            return 10;
          },
          getHGap: node => {
            if (node.type === "edge") {
              return 10;
            }
            return 60;
          },
          getSide: () => {
            return "right";
          }
        }
      });
      let centerX = 0;
      this.graph.node(node => {
        if (node.id === this.centerNode.id) {
          centerX = node.x;
        }
        if (node.type === "node" || node.type === "custTree_node") {
          let showLabel = "";
          if (node.name.length > 10) {
            showLabel = node.name.substring(0, 10) + "...";
          } else {
            showLabel = node.name;
          }
          return {
            label: showLabel,
            labelCfg: {
              position:
                node.children && node.children.length > 0
                  ? "right"
                  : node.x > centerX
                    ? "right"
                    : "left",
              offset: 5
            }
          };
        } else {
          return {
            label: "",
            labelCfg: {
              position: "",
              offset: 5
            }
          };
        }
      });
      this.graph.data(this.sourceData);
      this.graph.render();
      this.graph.fitCenter();
      // this.graph.layout(true);
      this.graph.zoom(1.2, {
        x: this.win.width / 2,
        y: this.win.height / 2
      });
      console.log("初始化G6脑图树【完成】", this.sourceData);
      // this.graph.focusItem(this.sourceData.id, true, {
      //   duration: 400
      // });
      this.graph.on("node:click", this.handleMindNodeClick);
      // 监听：canvas点击
      this.graph.on("canvas:click", () => {
        this.clearAllStats();
      });
    },
    // 切换布局
    changeLayout (val) {
      if (Object.keys(this.sourceData).length) {
        loading.show();
        this.graph.clear();
        this.graph.destroy();
        this.initMenu();
        this.initToolBar();
        this.initMiniMap();
        this.initToolTip();
        if (val === "mind") {
          this.initMindG6();
        } else {
          this.changeStyle(this.sourceData);
          this.initG6();
          this.graph.focusItem(this.selectNode.getModel().id);
        }
        // 切换布局后保持选中节点高亮及位于中心位置
        if (this.selectNode && Object.keys(this.selectNode).length) {
          this.graph.getNodes().forEach(node => {
            this.graph.clearItemStates(node);
            this.graph.setItemState(node, "dark", true);
          });
          this.graph.setItemState(this.selectNode._cfg.id, "dark", false);
          this.graph.setItemState(this.selectNode._cfg.id, "highlight", true);
        }
        this.graph.paint();
        loading.hide();
      }
    },
    // 初始化小地图
    initMiniMap () {
      this.minimap = new G6.Minimap({
        size: [250, 150]
      });
    },
    // 初始化工具栏
    initToolBar () {
      this.toolBar = new G6.ToolBar({
        position: { x: 10, y: 10 }
      });
      this.$nextTick(() => {
        const toolBarDom = document.getElementsByClassName(
          "g6-component-toolbar"
        );
        const redoText = toolBarDom[0].childNodes[0];
        const redo = toolBarDom[0].childNodes[1];
        const undoText = toolBarDom[0].childNodes[2];
        const undo = toolBarDom[0].childNodes[3];
        toolBarDom[0].removeChild(redoText);
        toolBarDom[0].removeChild(redo);
        toolBarDom[0].removeChild(undoText);
        toolBarDom[0].removeChild(undo);
      });
    },
    // 初始化窗口
    initWindow () {
      console.log('初始化窗口')
      this.win.height = (document.documentElement.clientHeight || document.body.clientHeight) - 70;
      this.win.width = (document.documentElement.clientWidth || document.body.clientWidth) - 70;
      this.canvasCenter = [this.win.width / 2, this.win.height / 2];
      this.initJsxNode();
      const _that = this
      //监听窗口改变
      window.addEventListener('resize', debounce(() => {
        _that.win.height = (document.documentElement.clientHeight || document.body.clientHeight) - 70;
        _that.win.width = (document.documentElement.clientWidth || document.body.clientWidth) - 70;
        console.log('窗口大小改变:' + _that.win.width + '*' + _that.win.height)
        _that.graph.changeSize(_that.win.width, _that.win.height)
      }, 500))
    },
    // 清空焦点高亮
    clearAllStats () {
      const that = this;
      this.selectNode = undefined;
      that.graph.setAutoPaint(false);
      that.graph.getNodes().forEach(node => {
        that.graph.clearItemStates(node);
      });
      that.graph.getEdges().forEach(edge => {
        that.graph.clearItemStates(edge);
      });
      that.graph.paint();
      that.graph.setAutoPaint(true);
    },
    // 初始化tooltip
    initToolTip () {
      console.log('初始化tooltip')
      this.toolTip = new G6.Tooltip({
        offsetX: 10,
        offsetY: 10,
        fixToNode: [1, 0.5],
        // 允许出现 tooltip 的 item 类型
        itemTypes: ["node"],
        // 是否允许tooltip出现
        shouldBegin: e => {
          // 若当前操作的节点 type 不为 'node'，则不展示
          if (e.item && e.item.getModel().type !== "custTree_node")
            return false;
          return true;
        },
        // 自定义 tooltip 内容
        getContent: e => {
          const item = e.item.getModel();
          if (e.item.getModel().type === "custTree_node") {
            const outDiv = document.createElement("div");
            const data = {
              name: item.name,
              path: item.img,
              desc: item.explain
            };
            outDiv.innerHTML = showTooltip(data);
            return outDiv;
          } else {
            return "关系节点";
          }
        }
      });
    },
    // 初始化右键菜单
    initMenu () {
      this.rightMenu = new G6.Menu({
        // 是否允许tooltip出现
        shouldBegin: e => {
          // 若当前操作的节点 type 不为 'custTree_node'，则不展示
          if (e.item && e.item.getModel().type !== "custTree_node")
            return false;
          return true;
        },
        getContent () {
          return `
              <ul id="rightMenu" class="tree-right-menu">
                <li class="tree-menu-btn">置位关键词</li>
                <li class="tree-menu-btn">搜索</li>
              </ul>`;
        },
        handleMenuClick: (target, item) => {
          if (target.innerHTML === "置位关键词") {
            const url =
              "http://" +
              window.location.host +
              "/grapheme?keyWord=" +
              encodeURIComponent(item.getModel().name);
            window.open(url);
          }
        },
        // 需要加上父级容器的 padding-left 16 与自身偏移量 10
        offsetX: 16 + 10,
        // 需要加上父级容器的 padding-top 24 、画布兄弟元素高度、与自身偏移量 10
        offsetY: -10,
        // 在哪些类型的元素上响应
        itemTypes: ["node"]
      });
    },
    // 脑图树布局切换辐射树改变样式
    changeStyle (data) {
      let processedData;
      if (Object.prototype.toString.call(data).slice(8, -1) === "Object") {
        processedData = [data];
      } else if (
        Object.prototype.toString.call(data).slice(8, -1) === "Array"
      ) {
        processedData = data;
      }
      processedData.forEach(item => {
        item.labelCfg.position = "bottom";
        item.labelCfg.offset = 10;
        if (item.children && item.children.length) {
          this.changeStyle(item.children);
        }
      });
      return data;
    },
    // 初始化数据
    initData (data) {
      let processedData;
      if (Object.prototype.toString.call(data).slice(8, -1) === "Object") {
        processedData = [data];
      } else if (
        Object.prototype.toString.call(data).slice(8, -1) === "Array"
      ) {
        processedData = data;
      }
      processedData.forEach(item => {
        if (item.type === "node") {
          //关键词节点
          item.id = createUuid(32);
          item.type = "custTree_node";
          if (!item.img) {
            item.img = require("../assets/image/logo.png");
          } else {
            item.img = mys ? require("../assets/image/test.png") : (baseUrl + item.img);
          }
        } else if ((item.type === "edge") && mys) {
          //关系节点
          item.id = createUuid(32);
          item.type = "custTree_rela_newUI";
        } else {
          item.id = createUuid(32);
          item.size = 40;
          if (item.name === "范畴") {
            item.icon = {
              show: true,
              img: require("../assets/image/fc.png"),
              width: 40,
              height: 40,
              cursor: "pointer"
            };
          } else if (item.name === "F") {
            item.icon = {
              show: true,
              img: require("../assets/image/F.png"),
              width: 40,
              height: 40,
              cursor: "pointer"
            };
          } else if (item.name === "D") {
            item.icon = {
              show: true,
              img: require("../assets/image/D.png"),
              width: 40,
              height: 40,
              cursor: "pointer"
            };
          } else if (item.name === "Z") {
            item.icon = {
              show: true,
              img: require("../assets/image/Z.png"),
              width: 40,
              height: 40,
              cursor: "pointer"
            };
          } else if (item.name === "S") {
            item.icon = {
              show: true,
              img: require("../assets/image/S.png"),
              width: 40,
              height: 40,
              cursor: "pointer"
            };
          } else if (item.name === "C") {
            item.icon = {
              show: true,
              img: require("../assets/image/C.png"),
              width: 40,
              height: 40,
              cursor: "pointer"
            };
          }
        }
        if (item.children && item.children.length) {
          this.initData(item.children);
        }
      });
      return data;
    },
    // 初始化自定义节点
    initJsxNode () {
      //自定义节点
      G6.registerNode("custTree_node", {
        jsx: (mys ? nodeNewUI.tree_node : custNode.tree_node)
      });
      G6.registerNode("custTree_rela_newUI", {
        jsx: nodeNewUI.rela_node
      });
    },
    // 搜索关键词
    async remoteMethod (query) {
      if (query !== "") {
        await this.getKeywordsList(query);
        this.loading = true;
        setTimeout(() => {
          this.loading = false;
          this.keyWordOptions = this.list.filter(item => {
            return item.label.toLowerCase().indexOf(query.toLowerCase()) > -1;
          });
        }, 200);
      } else {
        this.keyWordOptions = [];
      }
    },
    // 模糊查询列表
    async getKeywordsList (val) {
      const params = {
        nameLike: val
      };
      const res = await getKeywordsList(params);
      if (res.data.length) {
        this.list = res.data.map(item => {
          return { value: `${item}`, label: `${item}` };
        });
      }
    },
    // 查询按钮
    async handleSearch () {
      if (!this.form.keyWord) {
        this.$message({
          message: "请设置关键词！",
          type: "warning"
        });
        return;
      } else {
        this.isShow = true;
        this.selectNode = undefined;
        this.sourceData = {};
      }
      loading.show();
      if (this.graph) {
        this.graph.clear();
        this.graph.destroy();
      }
      await this.getTreeNode();
      this.initWindow();
      this.initMenu();
      this.initToolBar();
      this.initMiniMap();
      this.initToolTip();
      if (this.form.layout === "radiation") {
        this.initG6();
      } else {
        this.initMindG6();
      }
      loading.hide();
      this.graph.setItemState(this.centerNode.id, "highlight", true);
    },
    async getParams () {
      const firstLoading = window.location.href.indexOf("?") === -1;
      if (!firstLoading) {
        let urlParams = window.location.search.substring(1);
        this.form.keyWord = decodeURIComponent(urlParams).split("=")[1];
        this.handleSearch();
      }
    }
  }
};
</script>
<style lang="less">
@import "./main.less";

.main-page {
  min-height: 600px;
}

.opt-level /deep/ {
  position: absolute;
  top: 10px;
  left: 180px;

  .el-form {
    .el-form-item {
      margin-bottom: 0;

      .el-form-item__label {
        padding: 0;
        line-height: 28px;
      }

      .el-select {
        width: 120px;
      }
    }
  }
}

.opt-layout /deep/ {
  padding-top: 10px;
}

.main-page /deep/ {
  .el-empty {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  .tree-right-menu {
    display: flex;
    flex-direction: column;
    padding: 0;
    margin: 0;

    li {
      list-style-type: none;
    }

    .tree-menu-btn {
      min-width: 50px;
      text-align: center;
      margin: 5px 0;
      padding: 5px;
      cursor: pointer;
      color: #fff;
      background-color: #409eff;
      border: 1px solid #409eff;
      border-radius: 4px;

      &:hover {
        background-color: #66b1ff;
        border: 1px solid #66b1ff;
      }
    }
  }
}
</style>