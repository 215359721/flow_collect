<template>
  <div class="main-page">
    <div class="opt-div">
      <!-- 功能按钮 -->
      <div class="move-group">
        <el-button
          type="primary"
          icon="el-icon-back"
          size="mini"
          @click="goWeek('prv')"
        >上一周</el-button>
        <el-button
          type="primary"
          icon="el-icon-right"
          size="mini"
          @click="goWeek('next')"
        >下一周</el-button>
        <el-button
          style="width:60px;"
          size="mini"
          type="danger"
          @click="reloadPage"
        >刷新</el-button>
      </div>
      <div class="btn-group">
        <el-input-number
          v-model="animSec"
          :min="1"
          :max="99"
          size="mini"
          style="width:100px;margin-top:5px;"
        ></el-input-number>
        <el-button
          type="primary"
          style="width:100px;margin-top:5px;"
          size="mini"
          @click="goWeek('start')"
        >回起点</el-button>
        <el-button
          type="primary"
          style="width:100px;margin-top:5px;"
          size="mini"
          @click="goWeek('point')"
        >去指定周</el-button>
        <el-button
          type="primary"
          style="width:100px;margin-top:5px;"
          size="mini"
          :disabled="saveDisabled"
          @click="commitChanges"
        >保存更改</el-button>
      </div>
      <el-radio-group
        v-model="dataType"
        size="mini"
        style="margin-top:5px;"
        @change="changeDataType"
      >
        <el-radio-button label="mock">mock数据</el-radio-button>
        <el-radio-button label="real">动态数据</el-radio-button>
      </el-radio-group>
    </div>
    <!-- 分辨率信息 -->
    <div class="cur-num cur-resolving">
      <div class="mr5">screen：{{win.width}} * {{win.height}}</div>
    </div>
    <!-- 网格信息 -->
    <div class="cur-num cur-grid">
      <div class="mr5">gird：{{gird.width}} * {{Math.floor(gird.height)}}</div>
    </div>
    <!-- 指示器 -->
    <div
      class="cur-num"
      v-if="graph"
    >
      <div class="mr5">zoom：{{graph.getZoom().toFixed(2)}}</div>
      <div>当前周：{{curWeek}}</div>
    </div>
    <!-- 部门竖线 -->
    <div
      class="dep-line"
      :style="{height:canvas.height+'px'}"
    />
    <!-- 泳道横线 -->
    <div
      v-for="(item,index) in dep_num"
      :key="'yd_'+index"
      class="line"
      :style="{top:(Math.floor((canvas.height/dep_num))*(index+1))+'px'}"
    />
    <!-- 部门名称 -->
    <div
      v-for="(item,index) in depData"
      :key="index"
      class="dep-name"
      :style="{height:Math.floor(canvas.height/dep_num)+'px',top:(Math.floor(canvas.height/dep_num) * index)+'px'}"
      @click="depClick(index+1)"
    >{{item.name}}</div>
    <!-- 时间轴 -->
    <div
      class="timeBar-area"
      v-if="timeBarData.length"
      :style="{height:timeBarHei+'px',top:(win.height-timeBarHei)+'px'}"
    >
      <el-slider
        v-model="curWeek"
        :min="1"
        :max="timeBarData.length"
        :step="1"
        :format-tooltip="formatTooltip"
        :marks="timeBarMarks"
        :show-stops="false"
        class="time-bar"
        @change="changeSilder"
      />
    </div>
    <!-- 画布 -->
    <div id="canvasDiv"></div>
    <!-- 弹框 -->
    <el-dialog
      title="添加批注"
      :visible.sync="addMarkShow"
      width="30%"
      :close-on-click-modal="false"
      :close-on-press-escape="false"
    >
      <div class="mark-main">
        <div class="each-line">
          <div class="title">批注内容</div>
          <div class="content">
            <el-input
              size="mini"
              type="textarea"
              :rows="3"
              v-model="markObj.content"
              placeholder="请输入批注内容"
            ></el-input>
          </div>
        </div>
      </div>
      <div
        slot="footer"
        class="dialog-footer"
      >
        <el-button
          size="mini"
          @click="addMarkShow = false"
        >取消</el-button>
        <el-button
          type="primary"
          size="mini"
          @click="commitMark"
        >确定</el-button>
      </div>
    </el-dialog>
  </div>
</template>

<script>
// eslint-disable-next-line no-unused-vars
import _ from 'lodash'
import G6 from '@antv/g6'
import insertCss from 'insert-css'
// eslint-disable-next-line no-unused-vars
import loading from '../utils/loading'
import getTooTipHTML from '../data/tooTip'
import custNode from '../data/newNode/cust_node'
import testData from '../mock/testData'
import innerCss from '../data/insertCss'

import { getUpdateNodesPositionList, getNewEdgesList } from '../utils/common'
import { getXYdata, getMainData, modifyNodesPosition } from '../api/api'
insertCss(innerCss)
let _that = null

export default {
  // eslint-disable-next-line vue/no-unused-components
  components: {},
  data () {
    return {
      win: { height: 0, width: 0 },//window对象
      canvas: { height: 0, width: 0 },//画布对象
      sourceData: {},//数据源
      graph: null,//graph全局对象
      lineType: 'polyline',//线条样式(line,polyline,quadratic,cubic,arc)
      lineColor: '#cccccc',//线条颜色
      lineThick: 2,//线条粗细
      toolTip: '',//提示框内容
      toolBar: null,//工具栏
      minimap: null,//小地图
      rightMenu: null,//右键菜单
      //-------------------
      start_x: 100,//起始点X
      node_wid: 150,//单个节点宽度
      node_hei: 50,//单个节点高度
      node_pad: 5,//节点间隔
      node_eachLineNum: 4,//一行显示节点数量
      curOptNode: null,//当前操作的节点
      dataType: 'real',//数据形式
      configId: 1,//配置id（1-内网台式机，2-会议室大屏）
      //部门
      depData: [{ name: '部门1' }, { name: '部门2' }, { name: '部门3' }, { name: '部门4' }, { name: '部门5' }],//部门数据
      dep_num: 5,//部门数量
      //网格
      gird: { width: 0, height: 0, gap: 5 },//网格基本信息
      eachGirdWidth: 620,//单个网格宽度
      eachGirdHeight: 177,//单个网格高度
      //配置
      config: { type: 1, },
      //时间轴
      timeBar: null,//时间轴
      timeBarData: [{ "weekNo": 1, "end": "2021-01-01", "begin": "2021-01-11" }, { "weekNo": 2, "end": "2021-01-24", "begin": "2021-01-18" }, { "weekNo": 3, "end": "2021-01-31", "begin": "2021-01-25" }, { "weekNo": 4, "end": "2021-01-07", "begin": "2021-01-01" }, { "weekNo": 5, "end": "2021-01-14", "begin": "2021-01-08" }, { "weekNo": 6, "end": "2021-01-21", "begin": "2021-01-15" }, { "weekNo": 7, "end": "2021-01-28", "begin": "2021-01-22" }, { "weekNo": 8, "end": "2021-01-05", "begin": "2021-01-29" }, { "weekNo": 9, "end": "2021-01-12", "begin": "2021-01-06" }, { "weekNo": 10, "end": "2021-01-19", "begin": "2021-01-13" }],//时间轴数据
      timeBarHei: 40,//时间轴高度
      timeBarMarks: { 1: '', },//时间轴标注
      animSec: 1,//移动动画时长
      curWeek: 1,//当前显示周
      //批注
      addMarkShow: false,//添加批注弹框显示标识
      markObj: { content: '' },//批注内容对象
      //节点移动、连线
      saveDisabled: true,//保存标识
      nodeMoveList: [],//节点移动数据集
      addEdgesList: [],//新增连线数据集
    }
  },
  computed: {},
  mounted () {
    if (this.dataType === 'mock') {
      this.initWindow()
      this.sourceData = this.initData(testData({ height: this.canvas.height, width: this.canvas.height, way: this.dep_num }))
      this.initG6()
      this.printGrid()
    } else {
      this.requestXYData()
    }
  },
  methods: {
    /**
     * 请求部门记时间轴数据
     */
    async requestXYData () {
      const responseData = await getXYdata()
      this.depData = responseData.data.Y
      this.timeBarData = responseData.data.X
      this.dep_num = this.depData.length
      console.log(`部门数据(${this.dep_num}):`, this.depData)
      console.log(`时间轴数据(${this.timeBarData.length}):`, this.timeBarData)
      this.requestMainData()
    },
    /**
     * 请求全局节点数据
     */
    async requestMainData () {
      const responseData = await getMainData(this.config.type)
      console.log('请求全局节点数据:', responseData.data)
      //开始初始化
      this.initWindow()
      this.sourceData = this.initData(responseData.data)
      this.initG6()
      this.printGrid()
    },
    /**
     * 初始化G6
     */
    async initG6 () {
      const snapLine = new G6.SnapLine()
      G6.Util.processParallelEdges(this.sourceData.edges, 80, 'quadratic', 'polyline', 'loop')
      this.graph = new G6.Graph({
        container: 'canvasDiv',
        width: this.canvas.width,
        height: this.canvas.height,
        groupByTypes: true,
        fitView: false,
        fitViewPadding: 0,
        fitCenter: false,
        linkCenter: false,
        animate: true,
        enabledStack: true,
        renderer: 'canvas',
        modes: {
          default: ['brush-select', 'shortcuts-call', 'drag-node',
            { type: 'create-edge', trigger: 'click', key: 'shift' },
            { type: 'drag-canvas', direction: 'x', },
            { type: 'scroll-canvas', direction: 'x', }
          ],//'drag-canvas', 'drag-node','zoom-canvas', 'drag-node'
        },
        plugins: [this.toolTip, this.rightMenu, snapLine],
        //默认节点设置
        defaultNode: {
          size: [150, 50],
          color: '#000',
          style: {
            cursor: 'pointer',
            lineWidth: 2,
          }
        },
        //默认连线设置
        defaultEdge: {
          color: this.lineColor,
          type: this.lineType,//（quadratic-二阶贝塞尔曲线；cubic-三阶贝塞尔曲线）
          controlPoints: [],
          labelCfg: {
            autoRotate: true,
            refY: -10,
          },
          style: {
            lineWidth: this.lineThick,
            color: this.lineColor,
            endArrow: true,
            radius: 3,
            offset: 10,
          },
        },
        nodeStateStyles: {
          highlight: {
            opacity: 1.0,
          },
          dark: {
            opacity: 0.2,
          },
        },
        edgeStateStyles: {
          highlight: {
            lineWidth: 3,
            stroke: '#ff3300',
          },
        },
      })
      this.graph.data(this.sourceData)
      this.graph.render()
      this.graph.zoomTo(1.0)
      //监听：节点单击
      this.graph.on('node:click', function (e) {
        const item = e.item
        console.log(e)
        console.log('点击node:{' + item._cfg.model.id + ' , ' + item._cfg.model.label + '|' + item._cfg.model.x + ',' + item._cfg.model.y + '}')
        if (item._cfg.model.method === 'line') { return }
        //---高亮---
        _that.graph.setAutoPaint(false)
        _that.graph.getNodes().forEach(function (node) {
          _that.graph.clearItemStates(node)
          _that.graph.setItemState(node, 'dark', true)
        })
        _that.graph.setItemState(item, 'dark', false)
        _that.graph.setItemState(item, 'highlight', true)
        //递归节点
        _that.filtNodeAndEdge(_that.graph, item)
        _that.graph.paint()
        _that.graph.setAutoPaint(true)
      })
      //监听：canvas点击
      this.graph.on('canvas:click', () => {
        _that.clearAllStats()
      })
      //监听：节点拖拽完成
      this.graph.on('node:dragend', (e) => {
        const modelItem = {
          configId: this.configId,
          nodeId: e.item._cfg.model.id,
          nodeX: e.item._cfg.model.x,
          nodeY: e.item._cfg.model.y,
        }
        console.log('node拖拽完成:', modelItem)
        _that.nodeMoveList = getUpdateNodesPositionList(_that.nodeMoveList, modelItem)
        console.log('nodeMoveList内容:', _that.nodeMoveList)
        _that.saveDisabled = ((_that.addEdgesList.length === 0) && (_that.nodeMoveList.length === 0))
      })
      //监听：增加连线
      this.graph.on('aftercreateedge', (e) => {
        const curEdge = {
          source: e.edge._cfg.source._cfg.model.id,
          target: e.edge._cfg.target._cfg.model.id
        }
        console.log('增加连线:', curEdge)
        _that.addEdgesList = getNewEdgesList(_that.addEdgesList, curEdge)
        const edges = _that.graph.save().edges;
        G6.Util.processParallelEdges(edges, 80, 'quadratic', 'polyline', 'loop');
        _that.graph.getEdges().forEach((edge, i) => {
          _that.graph.updateItem(edge, {
            curveOffset: edges[i].curveOffset,
            curvePosition: edges[i].curvePosition,
          })
        })
        _that.saveDisabled = ((_that.addEdgesList.length === 0) && (_that.nodeMoveList.length === 0))
      })
    },
    filtNodeAndEdge (graph, item) {
      graph.getEdges().forEach(function (edge) {
        if (edge.getSource() === item) {
          graph.setItemState(edge.getTarget(), 'dark', false)
          graph.setItemState(edge.getTarget(), 'highlight', true)
          graph.setItemState(edge, 'highlight', true)
          edge.toFront()
        } else if (edge.getTarget() === item) {
          graph.setItemState(edge.getSource(), 'dark', false)
          graph.setItemState(edge.getSource(), 'highlight', true)
          graph.setItemState(edge, 'highlight', true)
          edge.toFront()
        } else {
          graph.setItemState(edge, 'highlight', false)
        }
      })
    },
    /**
     * 初始化右键菜单
     */
    initMenu () {
      this.rightMenu = new G6.Menu({
        getContent () {
          return `
          <div class="left-menu">
            <button class="btn btn-small submit bounce-left" fnname="addMark">添加批注</button>
            <button class="btn btn-small submit bounce-left" fnname="method_2">功能2</button>
            <button class="btn btn-small submit bounce-left" fnname="method_3">功能3</button>
          </div>`;
        },
        handleMenuClick: (target, item) => {
          // console.log(target, item)
          _that.curOptNode = item
          console.log('curOptNode:', _that.curOptNode)
          switch (target.getAttribute('fnname')) {
            case 'addMark': //添加批注
              _that.addMarkShow = true
              break
            case 'method_2':
              break
            case 'method_3':
              break
            case 'method_4':
              break
            default:
              break
          }
        },
        // 需要加上父级容器的 padding-left 16 与自身偏移量 10
        offsetX: 16 + 10,
        // 需要加上父级容器的 padding-top 24 、画布兄弟元素高度、与自身偏移量 10
        offsetY: -30,
        // 在哪些类型的元素上响应
        itemTypes: ['node'],
      })
    },
    /**
     * 初始化小地图
     */
    initMiniMap () {
      this.minimap = new G6.Minimap({
        size: [250, 150],
      });
    },
    /**
     * 初始化工具栏
     */
    initToolBar () {
      this.toolBar = new G6.ToolBar({
        position: { x: _that.win.width - 84, y: 10 },
      });
    },
    /**
     * 初始化tooltip
     */
    initToolTip () {
      this.toolTip = new G6.Tooltip({
        offsetX: 0,
        offsetY: 0,
        fixToNode: [1, 0.5],
        // 允许出现 tooltip 的 item 类型
        itemTypes: ['node', 'edge'],
        // 自定义 tooltip 内容
        getContent: (e) => {
          const outDiv = document.createElement('div')
          outDiv.style.width = 'fit-content'
          outDiv.style.height = 'fit-content'
          const model = e.item.getModel()
          if (e.item.getType() === 'node') {
            if (model.method === 'line') {
              //标示线节点
              outDiv.innerHTML = model.label + `(${model.x},${model.y})`
            } else {
              //普通节点
              outDiv.innerHTML = getTooTipHTML(model)
            }
          } else {
            const source = e.item.getSource()
            const target = e.item.getTarget()
            outDiv.innerHTML = `来源：${source.getModel().label}<br/>去向：${target.getModel().label}`
          }
          return outDiv
        },
      })
    },
    /**
     * 清空焦点高亮
     */
    clearAllStats () {
      const that = this
      that.graph.setAutoPaint(false)
      that.graph.getNodes().forEach(function (node) {
        that.graph.clearItemStates(node)
      })
      that.graph.getEdges().forEach(function (edge) {
        that.graph.clearItemStates(edge)
      })
      that.graph.paint()
      that.graph.setAutoPaint(true)
    },
    /**
     * 数据形式改变
     */
    async changeDataType (val) {
      this.dataType = val
      if (this.dataType === 'mock') {
        this.sourceData = this.initData(testData({ height: this.canvas.height, width: this.canvas.height, way: this.dep_num }))
      } else {
        const xyRsp = await getXYdata()
        this.depData = xyRsp.data.Y
        this.timeBarData = xyRsp.data.X
        this.dep_num = this.depData.length
        console.log(`部门数据(${this.dep_num}):`, this.depData)
        console.log(`时间轴数据(${this.timeBarData.length}):`, this.timeBarData)
        const mainRsp = await getMainData('1')
        console.log('请求全局节点数据:', mainRsp.data)
        this.sourceData = this.initData(mainRsp.data)
      }
      this.graph.changeData(this.sourceData)
    },

    /**
     * 初始化节点
     */
    initData (data) {
      //加入周节点
      this.timeBarData.forEach((element, index) => {
        const weekObj = {
          id: 'week_' + element.weekNo,
          label: '第' + element.weekNo + '周，' + element.begin + '至' + element.end,
          method: 'line',
          begin: element.begin,
          end: element.end,
          x: 100 + (_that.gird.gap * (4 * (index))) + (_that.node_wid * (4 * (index))),
          y: 0,
          width: 1,
          height: _that.canvas.height,
          color: (this.timeBarData.length === (index + 1)) ? 'red' : '#f2f2f2',
          dotline: (this.timeBarData.length !== (index + 1)),
        }
        data.nodes.push(weekObj)
      })
      //遍历节点
      data.nodes.forEach((element) => {
        //节点样式
        if ((element.id <= 20) || (element.icon === 'task')) {
          element.type = 'custNode_task'
        }
        if (((element.id > 20) && (element.id <= 99)) || (element.icon === 'MeetingInfo')) {
          element.type = 'custNode_chat'
        }
        if (element.method === 'line') {
          element.type = 'custNode_line'
        }
        if (element.method === 'mark') {
          element.type = 'custNode_mark'
        }
        //节点坐标微调
        if (element.y > 0) { element.y += 0 }
        //完成标识
        if (element.endDate !== '') { element.unfinish = true } else { element.unfinish = false }
      })
      //初始化silder-mark
      _that.timeBarData.forEach((element, i) => {
        _that.timeBarMarks[i + 1] = element.begin
      })
      // console.log('timeBarMarks:', _that.timeBarMarks)
      console.log('【当前数据】', data)
      return data
    },
    /**
     * 初始化自定义节点
     */
    initJsxNode () {
      //自定义节点
      G6.registerNode('custNode_task', {
        jsx: custNode.task_node,
      })
      G6.registerNode('custNode_chat', {
        jsx: custNode.chat_node,
      })
      G6.registerNode('custNode_mark', {
        jsx: custNode.mark_node,
      })
      G6.registerNode('custNode_line', {
        jsx: custNode.line_node,
      })
    },
    /**
     * 部门点击过滤
     */
    depClick (depId) {
      this.graph.setAutoPaint(false)
      this.graph.getNodes().forEach(function (node) {
        _that.graph.clearItemStates(node)
        _that.graph.setItemState(node, 'dark', true)
        const depid = node._cfg.model.dep
        if (depid === depId) {
          //部门高亮
          _that.graph.setItemState(node, 'highlight', true)
        }
      })
      this.graph.paint()
      this.graph.setAutoPaint(true)
    },
    /**
     * 切换周
     */
    changeSilder (val) {
      const descNode = this.graph.findById('week_' + val)
      const nodeInfo = descNode._cfg.model
      console.log(nodeInfo)
      if (nodeInfo) {
        this.$message({ message: `第${val}周，${nodeInfo.begin} 至 ${nodeInfo.end}` })
        this.moveTo(nodeInfo.x)
      } else {
        console.log('err:没有相关节点信息！')
      }
    },
    /**
     * 周移动
     */
    goWeek (pos) {
      switch (pos) {
        case 'prv'://上一周
          if (this.curWeek === 1) {
            this.$message({
              message: '没有更多上周数据',
              type: 'warning'
            })
            return
          } else {
            this.curWeek = this.curWeek - 1
          }
          break
        case 'next'://下一周
          this.curWeek = this.curWeek + 1
          break
        case 'start'://回起点
          this.curWeek = 1
          break
        case 'point'://去指定周
          this.curWeek = this.timeBarData.length
          break
        default:
          break;
      }
      this.changeSilder(this.curWeek)
    },
    /**
     * 移动到指定点(横坐标)
     */
    moveTo (x) {
      this.graph.moveTo(0 - (x - 197), 0, true, {
        duration: (_that.animSec * 1000)
      })
    },
    /**
     * 时间轴格式化提示
     */
    formatTooltip (val) {
      if (val) { return this.timeBarData[val - 1].begin }
      return ''
    },
    /**
     * 添加批注提交
     */
    commitMark () {
      const cur = this.curOptNode._cfg.model
      const model = {
        id: '902' + (Math.floor(Math.random() * (99999 - 1)) + 1),
        label: '批注',
        method: 'mark',
        x: cur.x + this.node_wid / 2,
        y: cur.y - this.node_hei / 2,
        type: 'custNode_mark',
      }
      this.graph.addItem('node', model)
      this.addMarkShow = false
    },
    /**
     * 提交修改节点信息
     */
    async commitChanges () {
      console.log('节点移动数据集:', this.nodeMoveList)
      console.log('新增连线数据集:', this.addEdgesList)
      const rsp = await modifyNodesPosition(this.nodeMoveList)
      console.log(rsp)
      if (rsp.data.code === 200) {
        this.$message({
          message: `保存成功`,
          type: 'success'
        })
        setTimeout(() => {
          this.reloadPage()
        }, 1000);
      } else {
        this.$message({
          message: `保存失败`,
          type: 'danger'
        })
      }
    },
    /**
     * 初始化窗口
     */
    initWindow () {
      _that = this
      // console.log(`wid:${window.innerWidth - 10};hei:${window.innerHeight - 10}`)
      // this.$message({
      //   message: `wid:${window.innerWidth - 10};hei:${window.innerHeight - 10}`,
      //   type: 'success'
      // })
      this.win.height = (document.documentElement.clientHeight || document.body.clientHeight) - 10
      this.win.width = (document.documentElement.clientWidth || document.body.clientWidth) - 10

      // this.win.height = this.win.height + (this.win.height)

      this.canvas.width = this.win.width
      // this.canvas.height = this.win.height - this.timeBarHei
      this.canvas.height = this.dep_num * this.eachGirdHeight
      console.log('winWid:' + this.win.width + ',winHei:' + this.win.height)
      console.log('CanvasWid:' + this.canvas.width + ',CanvasHei:' + this.canvas.height)
      this.initMenu()
      this.initToolBar()
      this.initMiniMap()
      this.initToolTip()
      this.initJsxNode()
      this.gird.width = this.node_wid * this.node_eachLineNum + this.node_pad * (this.node_eachLineNum)
      this.gird.height = (this.win.height - this.timeBarHei) / this.dep_num
    },
    /**
     * 打印网格信息
     */
    printGrid () {
      const eachGridHei = Math.floor((this.canvas.height / this.dep_num))
      console.log(`【eahc：${eachGridHei}】`)
      for (let i = 0; i < this.dep_num; i++) {
        const result = eachGridHei * (i + 1)
        console.log(`泳道${i + 1}:(${this.canvas.height} / ${this.dep_num}) * ${i + 1} = ${result}`)
      }
    },
    /**
     * 刷新页面
     */
    reloadPage () { location.reload() }
  }
}
</script>
<style lang='less'>
@import "./main.less";
@import "../assets/css/btn.css";
</style>